{% extends "base.html" %}

{% block content %}
<!-- Pharmacy Tab -->
<div id="pharmacy-tab" class="tab-content">
    <div class="filter-section">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3>Pharmacy Inventory Overview</h3>
            <a href="/export_pharmacy" class="btn btn-export">Export Pharmacy CSV</a>
        </div>
    </div>
    
    <div class="metrics-grid">
        <div class="metric-card">
            <div class="metric-value">{{ total_medicines }}</div>
            <div class="metric-label">Total Medicines</div>
        </div>
        <div class="metric-card">
            <div class="metric-value">{{ low_stock_medicines }}</div>
            <div class="metric-label">Low Stock Items</div>
        </div>
        <div class="metric-card">
            <div class="metric-value">{{ out_of_stock_medicines }}</div>
            <div class="metric-label">Out of Stock</div>
        </div>
        <div class="metric-card">
            <div class="metric-value">{{ pharmacy_categories }}</div>
            <div class="metric-label">Medicine Categories</div>
        </div>
    </div>
    
     <div class="charts-grid">
        <div class="chart-container">
            <canvas id="categoryChart"></canvas>
        </div>
        <div class="chart-container">
            <canvas id="stockStatusChart"></canvas>
        </div>
    </div>
    
    <div class="charts-grid">
        <div class="chart-container">
            <canvas id="expiryChart"></canvas>
        </div>
        <div class="chart-container">
            <canvas id="supplierChart"></canvas>
        </div>
    </div>
    
    <div class="table-container">
        <div class="table-header">
            <h3>Medicine Inventory ({{ pharmacy_table_count }} items)</h3>
        </div>
        <table>
            <thead>
                <tr>
                    <th>Medicine ID</th>
                    <th>Medicine Name</th>
                    <th>Category</th>
                    <th>Current Stock</th>
                    <th>Min Stock</th>
                    <th>Price</th>
                    <th>Supplier</th>
                    <th>Expiry Date</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="pharmacy-table-body">
                {% for medicine in pharmacy_table_data %}
                <tr class="table-row" data-type="pharmacy">
                    <td>{{ medicine.drug_id }}</td>
                    <td>{{ medicine.drug_name }}</td>
                    <td>{{ medicine.category }}</td>
                    <td>{{ medicine.current_stock }}</td>
                    <td>{{ medicine.min_stock if medicine.min_stock is defined else 5 }}</td>
                    <td>{{ medicine.price if medicine.price is defined else '-' }}</td>
                    <td>{{ medicine.supplier }}</td>
                    <td>{{ medicine.expiry_date.strftime("%Y-%m-%d") if medicine.expiry_date else "-" }}</td>
                    <td>
                        <span class="status-badge 
                            {% if medicine.current_stock == 0 %}status-occupied
                            {% elif medicine.current_stock <= (medicine.min_stock if medicine.min_stock is defined else 5) %}status-occupied
                            {% else %}status-available{% endif %}">
                            {% if medicine.current_stock == 0 %}Out of Stock
                            {% elif medicine.current_stock <= (medicine.min_stock if medicine.min_stock is defined else 5) %}Low Stock
                            {% else %}In Stock{% endif %}
                        </span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <div class="pagination" id="pharmacy-pagination">
            <button class="pagination-btn" onclick="changePage('pharmacy', -1)">Previous</button>
            <span class="pagination-info" id="pharmacy-page-info">Page 1 of {{ (pharmacy_table_count / 20)|round(0, 'ceil')|int }}</span>
            <button class="pagination-btn" onclick="changePage('pharmacy', 1)">Next</button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Chart 1: Medicine Category
    const categoryCtx = document.getElementById('categoryChart');
    if (categoryCtx) {
        const categoryData = {{ category_count|tojson }};
        if (Object.keys(categoryData).length > 0) {
            new Chart(categoryCtx, {
                type: 'pie',
                data: {
                    labels: Object.keys(categoryData),
                    datasets: [{
                        data: Object.values(categoryData),
                        backgroundColor: [
                            '#4361ee', '#4cc9f0', '#7209b7', '#3a0ca3', 
                            '#f72585', '#4895ef', '#560bad', '#b5179e'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Medicine Distribution by Category'
                        }
                    }
                }
            });
        }
    }

    // Chart 2: Stock Status
    const stockCtx = document.getElementById('stockStatusChart');
    if (stockCtx) {
        const stockData = {{ stock_status|tojson }};
        if (Object.keys(stockData).length > 0) {
            new Chart(stockCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(stockData),
                    datasets: [{
                        label: 'Number of Medicines',
                        data: Object.values(stockData),
                        backgroundColor: ['#4cc9f0', '#f72585', '#e63946']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Medicine Stock Status'
                        }
                    }
                }
            });
        }
    }

    // Chart 3: Expiring Medicines
    const expiryCtx = document.getElementById('expiryChart');
    if (expiryCtx) {
        const expiryData = {{ expiry_data|tojson }};
        if (expiryData.length > 0) {
            new Chart(expiryCtx, {
                type: 'bar',
                data: {
                    labels: expiryData.map(item => item.drug_name),
                    datasets: [{
                        label: 'Current Stock',
                        data: expiryData.map(item => item.current_stock),
                        backgroundColor: '#f72585'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Medicines Expiring in 30 Days'
                        }
                    }
                }
            });
        }
    }

    // Chart 4: Suppliers
    const supplierCtx = document.getElementById('supplierChart');
    if (supplierCtx) {
        const supplierData = {{ supplier_count|tojson }};
        if (Object.keys(supplierData).length > 0) {
            new Chart(supplierCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(supplierData),
                    datasets: [{
                        label: 'Number of Medicines',
                        data: Object.values(supplierData),
                        backgroundColor: '#4361ee'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Top 10 Suppliers'
                        }
                    }
                }
            });
        }
    }
});
</script>
{% endblock %}