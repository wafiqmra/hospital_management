{% extends "base.html" %}

{% block content %}
<!-- Patient Data Tab -->
<div id="patient-tab" class="tab-content">
    <div class="filter-section">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3>Patient Data Overview</h3>
            <a href="/export_patients" class="btn btn-export">Export Patient Data</a>
        </div>
    </div>
    
    <div class="patient-metrics-grid">
        <div class="patient-metric-card bg-success">
            <div class="patient-metric-value">{{ total_patients }}</div>
            <div class="patient-metric-label">Total Patients</div>
        </div>
        <div class="patient-metric-card bg-info">
            <div class="patient-metric-value">{{ gender_dist.get('L', 0) }}</div>
            <div class="patient-metric-label">Male Patients</div>
        </div>
        <div class="patient-metric-card bg-warning">
            <div class="patient-metric-value">{{ gender_dist.get('P', 0) }}</div>
            <div class="patient-metric-label">Female Patients</div>
        </div>
        <div class="patient-metric-card bg-secondary">
            <div class="patient-metric-value">{{ payment_dist.get('BPJS', 0) }}</div>
            <div class="patient-metric-label">BPJS Patients</div>
        </div>
    </div>
    
    <div class="patient-charts-grid">
        <div class="chart-container">
            <canvas id="genderChart"></canvas>
        </div>
        <div class="chart-container">
            <canvas id="ageChart"></canvas>
        </div>
    </div>
    
    <div class="patient-charts-grid">
        <div class="chart-container">
            <canvas id="paymentChart"></canvas>
        </div>
        <div class="chart-container">
            <canvas id="insuranceChart"></canvas>
        </div>
    </div>
    
    <div class="chart-container">
        <canvas id="cityChart"></canvas>
    </div>
    
    <div class="table-container">
        <div class="table-header">
            <h3>Patient Data ({{ patient_table_count }} records)</h3>
        </div>
        <table>
            <thead>
                <tr>
                    <th>Patient ID</th>
                    <th>Name</th>
                    <th>Gender</th>
                    <th>Age</th>
                    <th>City</th>
                    <th>Payment Type</th>
                    <th>Insurance Provider</th>
                </tr>
            </thead>
            <tbody id="patient-table-body">
                {% for patient in patient_table_data %}
                <tr class="table-row" data-type="patient">
                    <td>{{ patient.patient_id }}</td>
                    <td>{{ patient.name }}</td>
                    <td>{{ patient.gender }}</td>
                    <td>{{ patient.age }}</td>
                    <td>{{ patient.city }}</td>
                    <td>{{ patient.payment_type }}</td>
                    <td>{{ patient.insurance_provider if patient.insurance_provider else '-' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <div class="pagination" id="patient-pagination">
            <button class="pagination-btn" onclick="changePage('patient', -1)">Previous</button>
            <span class="pagination-info" id="patient-page-info">Page 1 of {{ (patient_table_count / 20)|round(0, 'ceil')|int }}</span>
            <button class="pagination-btn" onclick="changePage('patient', 1)">Next</button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Chart 1: Gender Distribution
    const genderCtx = document.getElementById('genderChart');
    if (genderCtx) {
        const genderData = {{ gender_dist|tojson }};
        if (Object.keys(genderData).length > 0) {
            new Chart(genderCtx, {
                type: 'pie',
                data: {
                    labels: Object.keys(genderData),
                    datasets: [{
                        data: Object.values(genderData),
                        backgroundColor: ['#4361ee', '#f72585']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Patient Gender Distribution'
                        }
                    }
                }
            });
        }
    }

    // Chart 2: Age Group Distribution
    const ageCtx = document.getElementById('ageChart');
    if (ageCtx) {
        const ageData = {{ age_group_count|tojson }};
        if (Object.keys(ageData).length > 0) {
            new Chart(ageCtx, {
                type: 'pie',
                data: {
                    labels: Object.keys(ageData),
                    datasets: [{
                        data: Object.values(ageData),
                        backgroundColor: ['#4361ee', '#4cc9f0', '#7209b7', '#3a0ca3']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Patient Age Group Distribution'
                        }
                    }
                }
            });
        }
    }

    // Chart 3: Payment Type
    const paymentCtx = document.getElementById('paymentChart');
    if (paymentCtx) {
        const paymentData = {{ payment_dist|tojson }};
        if (Object.keys(paymentData).length > 0) {
            new Chart(paymentCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(paymentData),
                    datasets: [{
                        data: Object.values(paymentData),
                        backgroundColor: ['#4361ee', '#4cc9f0', '#7209b7', '#3a0ca3']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Payment Type Distribution'
                        }
                    }
                }
            });
        }
    }

    // Chart 4: Insurance Provider
    const insuranceCtx = document.getElementById('insuranceChart');
    if (insuranceCtx) {
        const insuranceData = {{ insurance_dist|tojson }};
        if (Object.keys(insuranceData).length > 0) {
            new Chart(insuranceCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(insuranceData),
                    datasets: [{
                        data: Object.values(insuranceData),
                        backgroundColor: ['#4361ee', '#4cc9f0', '#7209b7', '#3a0ca3', '#f72585']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Insurance Provider Distribution'
                        }
                    }
                }
            });
        }
    }

    // Chart 5: Top Cities
    const cityCtx = document.getElementById('cityChart');
    if (cityCtx) {
        const cityData = {{ city_dist|tojson }};
        if (Object.keys(cityData).length > 0) {
            new Chart(cityCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(cityData),
                    datasets: [{
                        label: 'Number of Patients',
                        data: Object.values(cityData),
                        backgroundColor: '#4361ee'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Top 10 Cities by Patient Count'
                        }
                    }
                }
            });
        }
    }
});
</script>
{% endblock %}