{% extends "base.html" %}

{% block content %}
<!-- Patient Data Tab -->
<div id="patient-tab" class="tab-content">
    <div class="filter-section">
        <form class="filter-form" method="GET">
            <div class="form-group">
                <label for="gender">Gender</label>
                <select name="gender" id="gender">
                    <option value="All" {% if current_gender == 'All' %}selected{% endif %}>All Genders</option>
                    <option value="L" {% if current_gender == 'L' %}selected{% endif %}>Male</option>
                    <option value="P" {% if current_gender == 'P' %}selected{% endif %}>Female</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="payment_type">Payment Type</label>
                <select name="payment_type" id="payment_type">
                    <option value="All" {% if current_payment_type == 'All' %}selected{% endif %}>All Types</option>
                    <option value="BPJS" {% if current_payment_type == 'BPJS' %}selected{% endif %}>BPJS</option>
                    <option value="Umum" {% if current_payment_type == 'Umum' %}selected{% endif %}>Umum</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="age_group">Age Group</label>
                <select name="age_group" id="age_group">
                    <option value="All" {% if current_age_group == 'All' %}selected{% endif %}>All Ages</option>
                    <option value="Anak (<18)" {% if current_age_group == 'Anak (<18)' %}selected{% endif %}>Children (&lt;18)</option>
                    <option value="Dewasa Muda (18-39)" {% if current_age_group == 'Dewasa Muda (18-39)' %}selected{% endif %}>Young Adults (18-39)</option>
                    <option value="Dewasa (40-59)" {% if current_age_group == 'Dewasa (40-59)' %}selected{% endif %}>Adults (40-59)</option>
                    <option value="Lansia (60+)" {% if current_age_group == 'Lansia (60+)' %}selected{% endif %}>Elderly (60+)</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="search_patient">Search Patient</label>
                <input type="text" name="search_patient" id="search_patient" 
                       value="{{ search_patient }}" placeholder="Search by name or ID...">
            </div>
            
            <button type="submit" class="btn">Apply Filters</button>
            <a href="/export_patients?gender={{ current_gender }}&payment_type={{ current_payment_type }}&age_group={{ current_age_group }}&search_patient={{ search_patient }}" 
               class="btn btn-export">Export CSV</a>
            <a href="/patient" class="btn">Reset</a>
        </form>
    </div>
    
    <!-- Quick Actions -->
    <div class="quick-actions">
        <button class="quick-action-btn" onclick="filterByAge('Anak (<18)')">Children</button>
        <button class="quick-action-btn" onclick="filterByAge('Lansia (60+)')">Elderly</button>
        <button class="quick-action-btn" onclick="filterByPayment('BPJS')">BPJS Patients</button>
        <button class="quick-action-btn" onclick="filterByPayment('Umum')">Private Patients</button>
        <button class="quick-action-btn" onclick="filterByGender('L')">Male Patients</button>
        <button class="quick-action-btn" onclick="filterByGender('P')">Female Patients</button>
    </div>
    
    <div class="patient-metrics-grid">
        <div class="patient-metric-card bg-success">
            <div class="patient-metric-value">{{ total_patients }}</div>
            <div class="patient-metric-label">Total Patients</div>
        </div>
        <div class="patient-metric-card bg-info">
            <div class="patient-metric-value">{{ gender_dist.get('L', 0) }}</div>
            <div class="patient-metric-label">Male Patients</div>
        </div>
        <div class="patient-metric-card bg-warning">
            <div class="patient-metric-value">{{ gender_dist.get('P', 0) }}</div>
            <div class="patient-metric-label">Female Patients</div>
        </div>
        <div class="patient-metric-card bg-secondary">
            <div class="patient-metric-value">{{ payment_dist.get('BPJS', 0) }}</div>
            <div class="patient-metric-label">BPJS Patients</div>
        </div>
    </div>
    
    <!-- Search Box -->
    <div class="search-container">
        <input type="text" id="patient-search" class="search-box" placeholder="Search in patient records...">
        <span class="search-icon">üîç</span>
    </div>
    
    <div class="patient-charts-grid">
        <div class="chart-container">
            <canvas id="genderChart"></canvas>
        </div>
        <div class="chart-container">
            <canvas id="ageChart"></canvas>
        </div>
    </div>
    
    <div class="patient-charts-grid">
        <div class="chart-container">
            <canvas id="paymentChart"></canvas>
        </div>
        <div class="chart-container">
            <canvas id="insuranceChart"></canvas>
        </div>
    </div>
    
    <div class="chart-container">
        <canvas id="cityChart"></canvas>
    </div>
    
    <div class="table-container">
        <div class="table-header">
            <h3>Patient Data ({{ patient_table_count }} records)</h3>
            <div class="pagination-info">
                Showing <span class="showing-count">{{ [patient_table_count, 20]|min }}</span> of {{ patient_table_count }} records
            </div>
        </div>
        <table class="enhanced-table">
            <thead>
                <tr>
                    <th onclick="enhancedSortTable(1, 'patient-table-body')" style="cursor: pointer;">
                        Patient ID <span class="sort-icon">‚Üï</span>
                    </th>
                    <th onclick="enhancedSortTable(2, 'patient-table-body')" style="cursor: pointer;">
                        Name <span class="sort-icon">‚Üï</span>
                    </th>
                    <th onclick="enhancedSortTable(3, 'patient-table-body')" style="cursor: pointer;">
                        Gender <span class="sort-icon">‚Üï</span>
                    </th>
                    <th onclick="enhancedSortTable(4, 'patient-table-body')" style="cursor: pointer;">
                        Age <span class="sort-icon">‚Üï</span>
                    </th>
                    <th onclick="enhancedSortTable(5, 'patient-table-body')" style="cursor: pointer;">
                        City <span class="sort-icon">‚Üï</span>
                    </th>
                    <th onclick="enhancedSortTable(6, 'patient-table-body')" style="cursor: pointer;">
                        Payment Type <span class="sort-icon">‚Üï</span>
                    </th>
                    <th>Insurance Provider</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="patient-table-body">
                {% for patient in patient_table_data %}
                <tr class="table-row" data-type="patient">
                    <td>{{ patient.patient_id }}</td>
                    <td>{{ patient.name }}</td>
                    <td>
                        <span class="status-badge {% if patient.gender == 'L' %}status-available{% else %}status-pending{% endif %}">
                            {{ patient.gender }}
                        </span>
                    </td>
                    <td>{{ patient.age }}</td>
                    <td>{{ patient.city }}</td>
                    <td>
                        <span class="status-badge {% if patient.payment_type == 'BPJS' %}status-available{% else %}status-occupied{% endif %}">
                            {{ patient.payment_type }}
                        </span>
                    </td>
                    <td>{{ patient.insurance_provider if patient.insurance_provider else '-' }}</td>
                    <td>
                        <button onclick="viewPatientDetails('{{ patient.patient_id }}')" class="btn" style="padding: 5px 10px; font-size: 12px;">
                            View
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <div class="pagination" id="patient-pagination">
            <button class="pagination-btn" onclick="changePage('patient', -1)">Previous</button>
            <span class="pagination-info" id="patient-page-info">Page 1 of {{ (patient_table_count / 20)|round(0, 'ceil')|int }}</span>
            <button class="pagination-btn" onclick="changePage('patient', 1)">Next</button>
        </div>
    </div>
</div>

<!-- Patient Details Modal -->
<div id="patient-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
    <div style="background: white; padding: 25px; border-radius: 12px; width: 90%; max-width: 500px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h4 style="margin: 0;" id="modal-patient-name">Patient Details</h4>
            <button onclick="closePatientModal()" style="background: none; border: none; font-size: 18px; cursor: pointer; color: #666;">&times;</button>
        </div>
        <div id="patient-modal-content">
            <!-- Content will be filled by JavaScript -->
        </div>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button onclick="closePatientModal()" style="flex: 1; padding: 10px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer;">
                Close
            </button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Chart 1: Gender Distribution
    const genderCtx = document.getElementById('genderChart');
    if (genderCtx) {
        const genderData = {{ gender_dist|tojson }};
        if (Object.keys(genderData).length > 0) {
            new Chart(genderCtx, {
                type: 'pie',
                data: {
                    labels: Object.keys(genderData),
                    datasets: [{
                        data: Object.values(genderData),
                        backgroundColor: ['#4361ee', '#f72585']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Patient Gender Distribution'
                        }
                    }
                }
            });
        }
    }

    // Chart 2: Age Group Distribution
    const ageCtx = document.getElementById('ageChart');
    if (ageCtx) {
        const ageData = {{ age_group_count|tojson }};
        if (Object.keys(ageData).length > 0) {
            new Chart(ageCtx, {
                type: 'pie',
                data: {
                    labels: Object.keys(ageData),
                    datasets: [{
                        data: Object.values(ageData),
                        backgroundColor: ['#4361ee', '#4cc9f0', '#7209b7', '#3a0ca3']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Patient Age Group Distribution'
                        }
                    }
                }
            });
        }
    }

    // Chart 3: Payment Type
    const paymentCtx = document.getElementById('paymentChart');
    if (paymentCtx) {
        const paymentData = {{ payment_dist|tojson }};
        if (Object.keys(paymentData).length > 0) {
            new Chart(paymentCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(paymentData),
                    datasets: [{
                        data: Object.values(paymentData),
                        backgroundColor: ['#4361ee', '#4cc9f0', '#7209b7', '#3a0ca3']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Payment Type Distribution'
                        }
                    }
                }
            });
        }
    }

    // Chart 4: Insurance Provider
    const insuranceCtx = document.getElementById('insuranceChart');
    if (insuranceCtx) {
        const insuranceData = {{ insurance_dist|tojson }};
        if (Object.keys(insuranceData).length > 0) {
            new Chart(insuranceCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(insuranceData),
                    datasets: [{
                        data: Object.values(insuranceData),
                        backgroundColor: ['#4361ee', '#4cc9f0', '#7209b7', '#3a0ca3', '#f72585']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Insurance Provider Distribution'
                        }
                    }
                }
            });
        }
    }

    // Chart 5: Top Cities
    const cityCtx = document.getElementById('cityChart');
    if (cityCtx) {
        const cityData = {{ city_dist|tojson }};
        if (Object.keys(cityData).length > 0) {
            new Chart(cityCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(cityData),
                    datasets: [{
                        label: 'Number of Patients',
                        data: Object.values(cityData),
                        backgroundColor: '#4361ee'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Top 10 Cities by Patient Count'
                        }
                    }
                }
            });
        }
    }
});

function viewPatientDetails(patientId) {
    const tableData = {{ patient_table_data|tojson }};
    const patient = tableData.find(p => p.patient_id == patientId);
    
    if (!patient) return;
    
    document.getElementById('modal-patient-name').textContent = patient.name;
    document.getElementById('patient-modal-content').innerHTML = `
        <div style="display: flex; flex-direction: column; gap: 15px;">
            <div style="display: flex; justify-content: space-between;">
                <strong>Patient ID:</strong>
                <span>${patient.patient_id}</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <strong>Gender:</strong>
                <span>${patient.gender}</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <strong>Age:</strong>
                <span>${patient.age}</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <strong>City:</strong>
                <span>${patient.city}</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <strong>Payment Type:</strong>
                <span>${patient.payment_type}</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <strong>Insurance:</strong>
                <span>${patient.insurance_provider || '-'}</span>
            </div>
            <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 6px;">
                <strong>Quick Actions:</strong>
                <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
                    <button onclick="scheduleAppointmentForPatient('${patient.patient_id}')" class="btn" style="padding: 5px 10px; font-size: 12px;">
                        Schedule Visit
                    </button>
                    <button onclick="viewMedicalHistory('${patient.patient_id}')" class="btn" style="padding: 5px 10px; font-size: 12px;">
                        Medical History
                    </button>
                    <button onclick="contactPatient('${patient.patient_id}')" class="btn" style="padding: 5px 10px; font-size: 12px;">
                        Contact
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('patient-modal').style.display = 'flex';
}

function closePatientModal() {
    document.getElementById('patient-modal').style.display = 'none';
}

function scheduleAppointmentForPatient(patientId) {
    alert(`Scheduling appointment for patient ID: ${patientId}`);
}

function viewMedicalHistory(patientId) {
    alert(`Viewing medical history for patient ID: ${patientId}`);
}

function contactPatient(patientId) {
    alert(`Contacting patient ID: ${patientId}`);
}
</script>
{% endblock %}