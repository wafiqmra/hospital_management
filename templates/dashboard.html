{% extends "base.html" %}

{% block content %}
<!-- ========================== -->
<!-- üåü DASHBOARD RUMAH SAKIT  -->
<!-- ========================== -->

<div id="dashboard-tab" class="tab-content active">

    <!-- HEADER -->
    <div class="filter-section">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3>Dashboard Hari Ini - {{ today.strftime('%A, %d %B %Y') }}</h3>
            <div class="btn" onclick="location.reload()" style="background: var(--primary);">
                <i class="fas fa-sync-alt"></i> Refresh Data
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div id="loading-state" style="display: none; text-align: center; padding: 40px;">
        <div style="font-size: 48px; margin-bottom: 20px;">‚è≥</div>
        <h3>Memuat Data...</h3>
        <p>Silakan tunggu sebentar</p>
    </div>

    <!-- QUICK STATS -->
    <div class="metrics-grid">
        <div class="metric-card" style="border-left: 4px solid #4361ee;">
            <div class="metric-value">{{ stats.today_doctors }}</div>
            <div class="metric-label">Dokter Bertugas</div>
            <div class="metric-desc">Hari ini</div>
        </div>

        <div class="metric-card" style="border-left: 4px solid #4cc9f0;">
            <div class="metric-value">{{ stats.today_patients }}</div>
            <div class="metric-label">Pasien Baru</div>
            <div class="metric-desc">Hari ini</div>
        </div>

        <div class="metric-card" style="border-left: 4px solid #f72585;">
            <div class="metric-value">{{ stats.today_tests }}</div>
            <div class="metric-label">Tes Lab</div>
            <div class="metric-desc">Dijadwalkan hari ini</div>
        </div>

        <div class="metric-card" style="border-left: 4px solid #4895ef;">
            <div class="metric-value">{{ stats.pending_tests }}</div>
            <div class="metric-label">Tes Tertunda</div>
            <div class="metric-desc">Menunggu hasil</div>
        </div>
    </div>

    <div class="metrics-grid">
        <div class="metric-card" style="border-left: 4px solid #e63946;">
            <div class="metric-value">{{ stats.occupied_rooms }}/{{ stats.total_rooms }}</div>
            <div class="metric-label">Ruangan Terisi</div>
            <div class="metric-desc">{{ stats.occupancy_rate }}% terisi</div>
        </div>

        <div class="metric-card" style="border-left: 4px solid #7209b7;">
            <div class="metric-value">{{ stats.low_stock_medicines }}</div>
            <div class="metric-label">Obat Stok Rendah</div>
            <div class="metric-desc">Perlu restock</div>
        </div>

        <div class="metric-card" style="border-left: 4px solid #3a0ca3;">
            <div class="metric-value">{{ stats.active_staff }}</div>
            <div class="metric-label">Staff Aktif</div>
            <div class="metric-desc">Sedang bertugas</div>
        </div>

        <div class="metric-card" style="border-left: 4px solid #2a9d8f;">
            <div class="metric-value">{{ now.strftime('%H:%M') }}</div>
            <div class="metric-label">Waktu Sekarang</div>
            <div class="metric-desc">Update terakhir</div>
        </div>
    </div>

    <!-- CHARTS -->
    <div class="charts-grid">
        <!-- Chart Status Ruangan -->
        <div class="chart-container">
            <div class="chart-header">
                <h4>Status Ruangan</h4>
            </div>
            <div class="chart-wrapper">
                <canvas id="roomStatusChart"></canvas>
            </div>
        </div>

        <!-- Chart Status Stok Obat -->
        <div class="chart-container">
            <div class="chart-header">
                <h4>Status Stok Obat</h4>
            </div>
            <div class="chart-wrapper">
                <canvas id="stockStatusChart"></canvas>
            </div>
        </div>
    </div>

    <div class="charts-grid">
        <!-- Chart Jadwal Dokter -->
        <div class="chart-container">
            <div class="chart-header">
                <h4>Jadwal Dokter Hari Ini</h4>
            </div>
            <div class="chart-wrapper">
                <canvas id="doctorScheduleChart"></canvas>
            </div>
        </div>

        <!-- Chart Tes Lab -->
        <div class="chart-container">
            <div class="chart-header">
                <h4>Tes Laboratorium</h4>
            </div>
            <div class="chart-wrapper">
                <canvas id="labTestsChart"></canvas>
            </div>
        </div>
    </div>

    <!-- QUICK ACTIONS -->
    <div class="table-container">
        <div class="table-header">
            <h3>Quick Actions</h3>
        </div>
        <div class="quick-actions-grid">
            <a href="/doctor" class="btn" style="background: var(--primary);">üë®‚Äç‚öïÔ∏è Jadwal Dokter</a>
            <a href="/room" class="btn" style="background: var(--info);">üè• Manajemen Ruangan</a>
            <a href="/pharmacy" class="btn" style="background: var(--success);">üíä Stok Obat</a>
            <a href="/lab" class="btn" style="background: var(--warning);">üî¨ Tes Laboratorium</a>
        </div>
    </div>

    <!-- ALERTS -->
    {% if stats.low_stock_medicines > 0 %}
    <div class="table-container" style="border-left: 4px solid #f72585;">
        <div class="table-header"><h3 style="color: #f72585;">‚ö†Ô∏è Peringatan</h3></div>
        <div style="padding: 15px;">
            <p>Ada <strong>{{ stats.low_stock_medicines }} obat</strong> yang stoknya rendah dan perlu segera di-restock.</p>
            <a href="/pharmacy" class="btn" style="background: #f72585;">Cek Stok Obat</a>
        </div>
    </div>
    {% endif %}

    {% if stats.pending_tests > 0 %}
    <div class="table-container" style="border-left: 4px solid #4895ef;">
        <div class="table-header"><h3 style="color: #4895ef;">üìã Tindakan Diperlukan</h3></div>
        <div style="padding: 15px;">
            <p>Ada <strong>{{ stats.pending_tests }} tes laboratorium</strong> yang masih menunggu hasil.</p>
            <a href="/lab" class="btn" style="background: #4895ef;">Kelola Tes Lab</a>
        </div>
    </div>
    {% endif %}
</div>

<!-- ========================== -->
<!-- üåà STYLING -->
<!-- ========================== -->
<style>
:root {
    --primary: #4361ee;
    --secondary: #3f37c9;
    --success: #2a9d8f;
    --warning: #f4a261;
    --danger: #e63946;
    --info: #4cc9f0;
    --card-bg: #ffffff;
    --border-radius: 12px;
    --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    --transition: 0.3s ease;
    --text-primary: #333;
}

/* GENERAL LAYOUT */
body {
    font-family: 'Poppins', sans-serif;
    background-color: #f5f7fb;
    color: var(--text-primary);
    margin: 0;
    padding: 0;
}

#dashboard-tab {
    padding: 20px 30px;
}

/* METRICS GRID */
.metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 20px;
    margin-bottom: 25px;
}

.metric-card {
    background: var(--card-bg);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    padding: 20px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    transition: var(--transition);
    min-height: 120px;
}

.metric-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.12);
}

.metric-value {
    font-size: 28px;
    font-weight: 600;
}

.metric-label {
    font-size: 16px;
    color: #555;
}

.metric-desc {
    font-size: 12px;
    color: #888;
    margin-top: 4px;
}

/* CHART GRID - IMPROVED RESPONSIVENESS */
.charts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(min(100%, 500px), 1fr));
    gap: 25px;
    margin-bottom: 25px;
    justify-items: center;
    align-items: stretch;
}

.chart-container {
    width: 100%;
    background: var(--card-bg);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    padding: 20px;
    display: flex;
    flex-direction: column;
    min-height: 350px;
}

.chart-header {
    margin-bottom: 15px;
    border-bottom: 1px solid #eee;
    padding-bottom: 10px;
}

.chart-header h4 {
    margin: 0;
    color: #333;
    font-size: 16px;
    font-weight: 600;
}

.chart-wrapper {
    width: 100%;
    height: 100%;
    flex: 1;
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
}

.chart-wrapper canvas {
    max-width: 100% !important;
    height: auto !important;
}

.no-data {
    text-align: center;
    color: #555;
    padding: 20px;
}

.no-data div {
    font-size: 48px;
    margin-bottom: 10px;
}

/* TABLES & QUICK ACTIONS */
.table-container {
    background: var(--card-bg);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    margin-bottom: 25px;
    overflow-x: auto;
}

.table-header {
    padding: 15px 20px;
    border-bottom: 1px solid #eee;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.quick-actions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    padding: 20px;
}

/* BUTTONS */
.btn {
    display: inline-block;
    background: var(--primary);
    color: #fff;
    border: none;
    border-radius: var(--border-radius);
    padding: 12px 20px;
    text-decoration: none;
    font-weight: 500;
    cursor: pointer;
    transition: var(--transition);
    text-align: center;
}

.btn:hover {
    opacity: 0.9;
    transform: translateY(-2px);
}

/* RESPONSIVE IMPROVEMENTS */
@media (max-width: 1200px) {
    .charts-grid {
        grid-template-columns: 1fr;
    }
    
    .chart-container {
        min-height: 320px;
    }
}

@media (max-width: 1024px) {
    #dashboard-tab { 
        padding: 15px; 
    }
    
    .charts-grid {
        gap: 20px;
    }
    
    .chart-container {
        padding: 15px;
        min-height: 300px;
    }
}

@media (max-width: 768px) {
    .metrics-grid { 
        grid-template-columns: repeat(2, 1fr); 
        gap: 15px;
    }
    
    .metric-card {
        padding: 15px;
        min-height: 100px;
    }
    
    .metric-value { 
        font-size: 22px; 
    }
    
    .metric-label {
        font-size: 14px;
    }
    
    .chart-container { 
        min-height: 280px;
        padding: 12px;
    }
    
    .quick-actions-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
        padding: 15px;
    }
}

@media (max-width: 480px) {
    .metrics-grid { 
        grid-template-columns: 1fr; 
    }
    
    .metric-value { 
        font-size: 20px; 
    }
    
    .chart-container { 
        min-height: 250px;
        padding: 10px;
    }
    
    .quick-actions-grid {
        grid-template-columns: 1fr;
    }
    
    #dashboard-tab {
        padding: 10px;
    }
    
    .table-header h3 {
        font-size: 16px;
    }
}

/* Extra small devices */
@media (max-width: 360px) {
    .metric-card {
        padding: 12px;
    }
    
    .chart-container {
        min-height: 220px;
    }
    
    .no-data div {
        font-size: 36px;
    }
}
</style>

<!-- ========================== -->
<!-- ‚öôÔ∏è JAVASCRIPT -->
<!-- ========================== -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const refreshBtn = document.querySelector('.btn[onclick="location.reload()"]');
    const loadingState = document.getElementById('loading-state');
    const mainContent = document.getElementById('dashboard-tab');

    if (refreshBtn) {
        refreshBtn.addEventListener('click', function() {
            if (loadingState) loadingState.style.display = 'block';
            if (mainContent) mainContent.style.opacity = '0.5';
            setTimeout(() => location.reload(), 500);
        });
    }

    // Initialize Charts
    initializeCharts();

    // Handle window resize untuk chart
    let resizeTimeout;
    window.addEventListener('resize', function() {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(function() {
            // Reinitialize charts on resize for better responsiveness
            initializeCharts();
        }, 250);
    });
});

function initializeCharts() {
    // Chart Status Ruangan
    const roomCtx = document.getElementById('roomStatusChart').getContext('2d');
    new Chart(roomCtx, {
        type: 'doughnut',
        data: {
            labels: ['Terisi', 'Tersedia'],
            datasets: [{
                data: [{{ stats.occupied_rooms }}, {{ stats.available_rooms }}],
                backgroundColor: ['#e63946', '#2a9d8f'],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        usePointStyle: true
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.label}: ${context.raw} ruangan`;
                        }
                    }
                }
            }
        }
    });

    // Chart Status Stok Obat - SESUAI DENGAN VARIABEL DI APP.PY
    const stockCtx = document.getElementById('stockStatusChart').getContext('2d');
    
    // Hitung stok normal berdasarkan data yang ada di app.py
    const totalMedicines = {{ stats.low_stock_medicines }} + {{ stats.out_of_stock_medicines if stats.out_of_stock_medicines is defined else 0 }};
    const normalStock = totalMedicines - {{ stats.low_stock_medicines }} - {{ stats.out_of_stock_medicines if stats.out_of_stock_medicines is defined else 0 }};
    
    new Chart(stockCtx, {
        type: 'bar',
        data: {
            labels: ['Stok Normal', 'Stok Rendah', 'Habis'],
            datasets: [{
                label: 'Jumlah Obat',
                data: [
                    Math.max(0, normalStock),
                    {{ stats.low_stock_medicines }},
                    {{ stats.out_of_stock_medicines if stats.out_of_stock_medicines is defined else 0 }}
                ],
                backgroundColor: ['#2a9d8f', '#f4a261', '#e63946'],
                borderWidth: 0,
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 5
                    }
                }
            }
        }
    });

    // Chart Jadwal Dokter - DATA HARUS SESUAI DENGAN YANG DIHITUNG DI APP.PY
    const doctorCtx = document.getElementById('doctorScheduleChart').getContext('2d');
    new Chart(doctorCtx, {
        type: 'pie',
        data: {
            labels: ['Pagi', 'Siang', 'Sore', 'Malam'],
            datasets: [{
                data: [8, 6, 4, 2], // Data dummy, sesuaikan dengan data sebenarnya dari app.py
                backgroundColor: ['#4361ee', '#4cc9f0', '#7209b7', '#3a0ca3'],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        usePointStyle: true
                    }
                }
            }
        }
    });

    // Chart Tes Lab - DATA HARUS SESUAI DENGAN YANG DIHITUNG DI APP.PY
    const labCtx = document.getElementById('labTestsChart').getContext('2d');
    new Chart(labCtx, {
        type: 'line',
        data: {
            labels: ['08:00', '10:00', '12:00', '14:00', '16:00'],
            datasets: [{
                label: 'Tes Dijadwalkan',
                data: [3, 5, 8, 6, 4], // Data dummy, sesuaikan dengan data sebenarnya dari app.py
                borderColor: '#f72585',
                backgroundColor: 'rgba(247, 37, 133, 0.1)',
                tension: 0.3,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top'
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}
</script>

{% endblock %}