<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hospital Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link rel="stylesheet" href="static/styles.css">
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <i class="fas fa-hospital-alt"></i>
                <span>Rumah Sakit XYZ</span>
            </div>
            <div class="date">
                <i class="far fa-calendar-alt"></i>
                <span id="current-date">{{ now.strftime('%A, %d %B %Y') if now else '' }}</span>
            </div>
        </header>
        
        <h1 class="dashboard-title">Hospital Management Dashboard</h1>
        
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('doctor-tab')">Doctor Schedule</button>
            <button class="nav-tab" onclick="showTab('room-tab')">Room Management</button>
            <button class="nav-tab" onclick="showTab('patient-tab')">Patient Data</button>
        </div>
        
        <!-- Doctor Schedule Tab -->
        <div id="doctor-tab" class="tab-content active">
            <div class="filter-section">
                <form class="filter-form" method="GET">
                    <div class="form-group">
                        <label for="specialization">Specialization</label>
                        <select name="specialization" id="specialization">
                            {% for spec in specializations %}
                                <option value="{{ spec }}" {% if current_specialization == spec %}selected{% endif %}>
                                    {{ spec }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="day">Day</label>
                        <select name="day" id="day">
                            {% for day in days %}
                                <option value="{{ day }}" {% if current_day == day %}selected{% endif %}>
                                    {{ day }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="search_doctor">Search Doctor</label>
                        <input type="text" name="search_doctor" id="search_doctor" 
                               value="{{ search_doctor }}" placeholder="Enter doctor name...">
                    </div>
                    
                    <button type="submit" class="btn">Apply Filters</button>
                    <a href="/export?specialization={{ current_specialization }}&day={{ current_day }}&search_doctor={{ search_doctor }}" 
                       class="btn btn-export">Export CSV</a>
                    <a href="/" class="btn">Reset</a>
                </form>
            </div>
            
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-value">{{ total_doctors }}</div>
                    <div class="metric-label">Total Doctors</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">{{ total_schedules }}</div>
                    <div class="metric-label">Total Schedules</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">{{ total_specializations }}</div>
                    <div class="metric-label">Specializations</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">{{ total_doctor_rooms }}</div>
                    <div class="metric-label">Rooms Used</div>
                </div>
            </div>
            
            <div class="charts-grid">
                <div class="chart-container">
                    {{ chart_spec|safe }}
                </div>
                <div class="chart-container">
                    {{ chart_day|safe }}
                </div>
                <div class="chart-container">
                    {{ chart_heatmap|safe }}
                </div>
                <div class="chart-container">
                    {{ chart_rooms|safe }}
                </div>
            </div>
            
            <div class="table-container">
                <div class="table-header">
                    <h3>Doctor Schedules ({{ table_count }} records)</h3>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Doctor Name</th>
                            <th>Specialization</th>
                            <th>Day</th>
                            <th>Start Time</th>
                            <th>End Time</th>
                            <th>Room ID</th>
                        </tr>
                    </thead>
                    <tbody id="doctor-table-body">
                        {% for row in table_data %}
                        <tr class="table-row" data-type="doctor">
                            <td>{{ row.name }}</td>
                            <td>{{ row.specialization }}</td>
                            <td>{{ row.schedule_day }}</td>
                            <td>{{ row.start_time }}</td>
                            <td>{{ row.end_time }}</td>
                            <td>{{ row.room_id }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <div class="pagination" id="doctor-pagination">
                    <button class="pagination-btn" onclick="changePage('doctor', -1)">Previous</button>
                    <span class="pagination-info" id="doctor-page-info">Page 1 of {{ (table_count / 20)|round(0, 'ceil')|int }}</span>
                    <button class="pagination-btn" onclick="changePage('doctor', 1)">Next</button>
                </div>
            </div>
        </div>
        
        <!-- Room Management Tab -->
        <div id="room-tab" class="tab-content">
            <div class="filter-section">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3>Room Management Overview</h3>
                    <a href="/export_rooms" class="btn btn-export">Export Rooms CSV</a>
                </div>
            </div>
            
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-value">{{ total_rooms }}</div>
                    <div class="metric-label">Total Rooms</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">{{ occupied_rooms }}</div>
                    <div class="metric-label">Occupied Rooms</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">{{ available_rooms }}</div>
                    <div class="metric-label">Available Rooms</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">{{ "%.1f"|format((occupied_rooms / total_rooms * 100) if total_rooms > 0 else 0) }}%</div>
                    <div class="metric-label">Overall Occupancy</div>
                </div>
            </div>
            
            <div class="room-stats">
                {% for room_type, stats in room_stats.items() %}
                <div class="room-stat-card">
                    <div class="room-stat-header">
                        <span class="room-type">{{ room_type }}</span>
                        <span class="occupancy-rate">{{ stats.occupancy_rate }}%</span>
                    </div>
                    <div>Occupied: {{ stats.occupied }}/{{ stats.total }}</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 75%"></div>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <div class="charts-grid">
                <div class="chart-container">
                    {{ chart_room_type|safe }}
                </div>
                <div class="chart-container">
                    {{ chart_occupancy|safe }}
                </div>
            </div>
            
            <div class="table-container">
                <div class="table-header">
                    <h3>Room Details ({{ room_table_count }} rooms)</h3>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Room ID</th>
                            <th>Room Name</th>
                            <th>Room Type</th>
                            <th>Capacity</th>
                            <th>Current Occupancy</th>
                            <th>Status</th>
                            <th>Special Notes</th>
                            <th>Last Updated</th>
                        </tr>
                    </thead>
                    <tbody id="room-table-body">
                        {% for room in room_table_data %}
                        <tr class="table-row" data-type="room">
                            <td>{{ room.room_id }}</td>
                            <td>{{ room.room_name }}</td>
                            <td>{{ room.room_type }}</td>
                            <td>{{ room.capacity }}</td>
                            <td>{{ room.current_occupancy }}</td>
                            <td>
                                <span class="status-badge {% if room.current_occupancy > 0 %}status-occupied{% else %}status-available{% endif %}">
                                    {% if room.current_occupancy > 0 %}Occupied{% else %}Available{% endif %}
                                </span>
                            </td>
                            <td>{{ room.special_note if room.special_note else '-' }}</td>
                            <td>{{ room.last_updated }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <div class="pagination" id="room-pagination">
                    <button class="pagination-btn" onclick="changePage('room', -1)">Previous</button>
                    <span class="pagination-info" id="room-page-info">Page 1 of {{ (room_table_count / 20)|round(0, 'ceil')|int }}</span>
                    <button class="pagination-btn" onclick="changePage('room', 1)">Next</button>
                </div>
            </div>
        </div>
        
        <!-- Patient Data Tab -->
        <div id="patient-tab" class="tab-content">
            <div class="filter-section">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3>Patient Data Overview</h3>
                    <a href="/export_patients" class="btn btn-export">Export Patient Data</a>
                </div>
            </div>
            
            <div class="patient-metrics-grid">
                <div class="patient-metric-card bg-success">
                    <div class="patient-metric-value">{{ total_patients }}</div>
                    <div class="patient-metric-label">Total Patients</div>
                </div>
                <div class="patient-metric-card bg-info">
                    <div class="patient-metric-value">{{ gender_dist.get('L', 0) }}</div>
                    <div class="patient-metric-label">Male Patients</div>
                </div>
                <div class="patient-metric-card bg-warning">
                    <div class="patient-metric-value">{{ gender_dist.get('P', 0) }}</div>
                    <div class="patient-metric-label">Female Patients</div>
                </div>
                <div class="patient-metric-card bg-secondary">
                    <div class="patient-metric-value">{{ payment_dist.get('BPJS', 0) }}</div>
                    <div class="patient-metric-label">BPJS Patients</div>
                </div>
            </div>
            
            <div class="patient-charts-grid">
                <div class="chart-container">
                    {{ chart_gender|safe }}
                </div>
                <div class="chart-container">
                    {{ chart_age|safe }}
                </div>
            </div>
            
            <div class="patient-charts-grid">
                <div class="chart-container">
                    {{ chart_payment|safe }}
                </div>
                <div class="chart-container">
                    {{ chart_insurance|safe }}
                </div>
            </div>
            
            <div class="chart-container">
                {{ chart_city|safe }}
            </div>
            
            <div class="table-container">
                <div class="table-header">
                    <h3>Patient Data ({{ patient_table_count }} records)</h3>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Patient ID</th>
                            <th>Name</th>
                            <th>Gender</th>
                            <th>Age</th>
                            <th>City</th>
                            <th>Payment Type</th>
                            <th>Insurance Provider</th>
                        </tr>
                    </thead>
                    <tbody id="patient-table-body">
                        {% for patient in patient_table_data %}
                        <tr class="table-row" data-type="patient">
                            <td>{{ patient.patient_id }}</td>
                            <td>{{ patient.name }}</td>
                            <td>{{ patient.gender }}</td>
                            <td>{{ patient.age }}</td>
                            <td>{{ patient.city }}</td>
                            <td>{{ patient.payment_type }}</td>
                            <td>{{ patient.insurance_provider if patient.insurance_provider else '-' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <div class="pagination" id="patient-pagination">
                    <button class="pagination-btn" onclick="changePage('patient', -1)">Previous</button>
                    <span class="pagination-info" id="patient-page-info">Page 1 of {{ (patient_table_count / 20)|round(0, 'ceil')|int }}</span>
                    <button class="pagination-btn" onclick="changePage('patient', 1)">Next</button>
                </div>
            </div>
        </div>
    </div>
    <script src="static/script.js"></script>
</body>
</html>