{% extends "base.html" %}

{% block content %}
<!-- ========================== -->
<!-- üåü DASHBOARD RUMAH SAKIT  -->
<!-- ========================== -->

<div id="dashboard-tab" class="tab-content active">

    <!-- HEADER -->
    <div class="filter-section">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3>Dashboard Hari Ini - {{ today.strftime('%A, %d %B %Y') }}</h3>
            <div class="btn" onclick="location.reload()" style="background: var(--primary);">
                <i class="fas fa-sync-alt"></i> Refresh Data
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div id="loading-state" style="display: none; text-align: center; padding: 40px;">
        <div style="font-size: 48px; margin-bottom: 20px;">‚è≥</div>
        <h3>Memuat Data...</h3>
        <p>Silakan tunggu sebentar</p>
    </div>

    <!-- QUICK STATS -->
    <div class="metrics-grid">
        <div class="metric-card" style="border-left: 4px solid #4361ee;">
            <div class="metric-value">{{ stats.today_doctors }}</div>
            <div class="metric-label">Dokter Bertugas</div>
            <div class="metric-desc">Hari ini</div>
        </div>

        <div class="metric-card" style="border-left: 4px solid #4cc9f0;">
            <div class="metric-value">{{ stats.today_patients }}</div>
            <div class="metric-label">Pasien Baru</div>
            <div class="metric-desc">Hari ini</div>
        </div>

        <div class="metric-card" style="border-left: 4px solid #f72585;">
            <div class="metric-value">{{ stats.today_tests }}</div>
            <div class="metric-label">Tes Lab</div>
            <div class="metric-desc">Dijadwalkan hari ini</div>
        </div>

        <div class="metric-card" style="border-left: 4px solid #4895ef;">
            <div class="metric-value">{{ stats.pending_tests }}</div>
            <div class="metric-label">Tes Tertunda</div>
            <div class="metric-desc">Menunggu hasil</div>
        </div>
    </div>

    <div class="metrics-grid">
        <div class="metric-card" style="border-left: 4px solid #e63946;">
            <div class="metric-value">{{ stats.occupied_rooms }}/{{ stats.total_rooms }}</div>
            <div class="metric-label">Ruangan Terisi</div>
            <div class="metric-desc">{{ stats.occupancy_rate }}% terisi</div>
        </div>

        <div class="metric-card" style="border-left: 4px solid #7209b7;">
            <div class="metric-value">{{ stats.low_stock_medicines }}</div>
            <div class="metric-label">Obat Stok Rendah</div>
            <div class="metric-desc">Perlu restock</div>
        </div>

        <div class="metric-card" style="border-left: 4px solid #3a0ca3;">
            <div class="metric-value">{{ stats.active_staff }}</div>
            <div class="metric-label">Staff Aktif</div>
            <div class="metric-desc">Sedang bertugas</div>
        </div>

        <div class="metric-card" style="border-left: 4px solid #2a9d8f;">
            <div class="metric-value">{{ now.strftime('%H:%M') }}</div>
            <div class="metric-label">Waktu Sekarang</div>
            <div class="metric-desc">Update terakhir</div>
        </div>
    </div>

    <!-- OVERVIEW STATS -->
    <div class="metrics-grid">
        <div class="metric-card" style="border-left: 4px solid #4361ee;">
            <div class="metric-value">{{ stats.total_patients }}</div>
            <div class="metric-label">Total Pasien</div>
            <div class="metric-desc">Terdaftar</div>
        </div>

        <div class="metric-card" style="border-left: 4px solid #f72585;">
            <div class="metric-value">{{ stats.total_lab_tests }}</div>
            <div class="metric-label">Total Tes Lab</div>
            <div class="metric-desc">Semua waktu</div>
        </div>

        <div class="metric-card" style="border-left: 4px solid #7209b7;">
            <div class="metric-value">{{ stats.total_medicines }}</div>
            <div class="metric-label">Total Obat</div>
            <div class="metric-desc">Dalam inventory</div>
        </div>

        <div class="metric-card" style="border-left: 4px solid #2a9d8f;">
            <div class="metric-value">{{ stats.out_of_stock_medicines }}</div>
            <div class="metric-label">Obat Habis</div>
            <div class="metric-desc">Perlu restock</div>
        </div>
    </div>

    <!-- CHARTS GRID -->
    <div class="charts-grid">
        <!-- Chart Dokter Hari Ini -->
        <div class="chart-container">
            <div class="chart-header">
                <h4>üë®‚Äç‚öïÔ∏è Dokter Bertugas Hari Ini</h4>
            </div>
            <div class="chart-wrapper">
                <canvas id="todayDoctorsChart"></canvas>
            </div>
        </div>

        <!-- Chart Status Ruangan -->
        <div class="chart-container">
            <div class="chart-header">
                <h4>üè• Status Ruangan</h4>
            </div>
            <div class="chart-wrapper">
                <canvas id="roomStatusChart"></canvas>
            </div>
        </div>
    </div>

    <div class="charts-grid">
        <!-- Chart Status Stok Obat -->
        <div class="chart-container">
            <div class="chart-header">
                <h4>üíä Status Stok Obat</h4>
            </div>
            <div class="chart-wrapper">
                <canvas id="stockStatusChart"></canvas>
            </div>
        </div>

        <!-- Chart Tes Lab Hari Ini -->
        <div class="chart-container">
            <div class="chart-header">
                <h4>üî¨ Tes Lab Hari Ini</h4>
            </div>
            <div class="chart-wrapper">
                <canvas id="todayTestsChart"></canvas>
            </div>
        </div>
    </div>

    <!-- QUICK ACTIONS -->
    <div class="table-container">
        <div class="table-header">
            <h3>üöÄ Quick Actions</h3>
        </div>
        <div class="quick-actions-grid">
            <a href="/doctor" class="btn" style="background: var(--primary);">
                <i class="fas fa-user-md"></i> Jadwal Dokter
            </a>
            <a href="/room" class="btn" style="background: var(--info);">
                <i class="fas fa-bed"></i> Manajemen Ruangan
            </a>
            <a href="/pharmacy" class="btn" style="background: var(--success);">
                <i class="fas fa-pills"></i> Stok Obat
            </a>
            <a href="/lab" class="btn" style="background: var(--warning);">
                <i class="fas fa-flask"></i> Tes Laboratorium
            </a>
            <a href="/patient" class="btn" style="background: #7209b7;">
                <i class="fas fa-users"></i> Data Pasien
            </a>
            <a href="/staff" class="btn" style="background: #3a0ca3;">
                <i class="fas fa-user-tie"></i> Staff Management
            </a>
        </div>
    </div>

    <!-- ALERTS & NOTIFICATIONS -->
    {% if stats.low_stock_medicines > 0 or stats.out_of_stock_medicines > 0 %}
    <div class="table-container" style="border-left: 4px solid #f72585;">
        <div class="table-header">
            <h3 style="color: #f72585;">‚ö†Ô∏è Peringatan Stok Obat</h3>
        </div>
        <div style="padding: 15px;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                {% if stats.low_stock_medicines > 0 %}
                <div style="background: #fff3cd; padding: 10px; border-radius: 6px;">
                    <strong style="color: #856404;">üü° Stok Rendah:</strong> 
                    <span style="color: #856404;">{{ stats.low_stock_medicines }} obat</span>
                </div>
                {% endif %}
                {% if stats.out_of_stock_medicines > 0 %}
                <div style="background: #f8d7da; padding: 10px; border-radius: 6px;">
                    <strong style="color: #721c24;">üî¥ Stok Habis:</strong> 
                    <span style="color: #721c24;">{{ stats.out_of_stock_medicines }} obat</span>
                </div>
                {% endif %}
            </div>
            <a href="/pharmacy" class="btn" style="background: #f72585; margin-top: 10px;">
                <i class="fas fa-exclamation-triangle"></i> Cek Stok Obat
            </a>
        </div>
    </div>
    {% endif %}

    {% if stats.pending_tests > 0 %}
    <div class="table-container" style="border-left: 4px solid #4895ef;">
        <div class="table-header">
            <h3 style="color: #4895ef;">üìã Tindakan Diperlukan</h3>
        </div>
        <div style="padding: 15px;">
            <p>Ada <strong>{{ stats.pending_tests }} tes laboratorium</strong> yang masih menunggu hasil.</p>
            <a href="/lab" class="btn" style="background: #4895ef;">
                <i class="fas fa-tasks"></i> Kelola Tes Lab
            </a>
        </div>
    </div>
    {% endif %}

    {% if stats.occupancy_rate > 80 %}
    <div class="table-container" style="border-left: 4px solid #e63946;">
        <div class="table-header">
            <h3 style="color: #e63946;">üè• Kapasitas Ruangan Tinggi</h3>
        </div>
        <div style="padding: 15px;">
            <p>Occupancy rate mencapai <strong>{{ stats.occupancy_rate }}%</strong>. Pertimbangkan untuk menambah kapasitas.</p>
            <a href="/room" class="btn" style="background: #e63946;">
                <i class="fas fa-bed"></i> Kelola Ruangan
            </a>
        </div>
    </div>
    {% endif %}

</div>

<style>
.metric-desc {
    font-size: 12px;
    color: #888;
    margin-top: 4px;
}

.chart-wrapper {
    width: 100%;
    height: 300px;
    position: relative;
}

.no-data {
    text-align: center;
    padding: 40px;
    color: #666;
}

.no-data div {
    font-size: 48px;
    margin-bottom: 10px;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const refreshBtn = document.querySelector('.btn[onclick="location.reload()"]');
    const loadingState = document.getElementById('loading-state');
    const mainContent = document.getElementById('dashboard-tab');

    if (refreshBtn) {
        refreshBtn.addEventListener('click', function() {
            if (loadingState) loadingState.style.display = 'block';
            if (mainContent) mainContent.style.opacity = '0.5';
            setTimeout(() => location.reload(), 500);
        });
    }

    // Initialize Charts
    initializeCharts();
});

function initializeCharts() {
    const stats = {{ stats|tojson }};
    const todayDoctorsSpec = {{ today_doctors_spec|tojson }};
    const todayTestsStatus = {{ today_tests_status|tojson }};
    const roomStats = {{ room_stats|tojson }};

    // Chart 1: Today's Doctors by Specialization
    const doctorsCtx = document.getElementById('todayDoctorsChart');
    if (doctorsCtx) {
        if (Object.keys(todayDoctorsSpec).length > 0) {
            new Chart(doctorsCtx, {
                type: 'pie',
                data: {
                    labels: Object.keys(todayDoctorsSpec),
                    datasets: [{
                        data: Object.values(todayDoctorsSpec),
                        backgroundColor: [
                            '#4361ee', '#4cc9f0', '#7209b7', '#3a0ca3', 
                            '#f72585', '#4895ef', '#560bad', '#b5179e'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `Total: ${stats.today_doctors} Dokter`
                        }
                    }
                }
            });
        } else {
            doctorsCtx.parentElement.innerHTML = `
                <div class="no-data">
                    <div>üë®‚Äç‚öïÔ∏è</div>
                    <p>Tidak ada jadwal dokter hari ini</p>
                </div>
            `;
        }
    }

    // Chart 2: Room Status
    const roomCtx = document.getElementById('roomStatusChart');
    if (roomCtx) {
        new Chart(roomCtx, {
            type: 'doughnut',
            data: {
                labels: ['Terisi', 'Tersedia'],
                datasets: [{
                    data: [stats.occupied_rooms, stats.available_rooms],
                    backgroundColor: ['#e63946', '#2a9d8f']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });
    }

    // Chart 3: Stock Status
    const stockCtx = document.getElementById('stockStatusChart');
    if (stockCtx) {
        const normalStock = stats.total_medicines - stats.low_stock_medicines - stats.out_of_stock_medicines;
        
        new Chart(stockCtx, {
            type: 'bar',
            data: {
                labels: ['Stok Normal', 'Stok Rendah', 'Habis'],
                datasets: [{
                    label: 'Jumlah Obat',
                    data: [
                        Math.max(0, normalStock),
                        stats.low_stock_medicines,
                        stats.out_of_stock_medicines
                    ],
                    backgroundColor: ['#2a9d8f', '#f4a261', '#e63946']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });
    }

    // Chart 4: Today's Lab Tests
    const testsCtx = document.getElementById('todayTestsChart');
    if (testsCtx) {
        if (Object.keys(todayTestsStatus).length > 0) {
            new Chart(testsCtx, {
                type: 'pie',
                data: {
                    labels: Object.keys(todayTestsStatus),
                    datasets: [{
                        data: Object.values(todayTestsStatus),
                        backgroundColor: ['#4cc9f0', '#f72585', '#e63946', '#7209b7']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `Total: ${stats.today_tests} Tes`
                        }
                    }
                }
            });
        } else {
            testsCtx.parentElement.innerHTML = `
                <div class="no-data">
                    <div>üî¨</div>
                    <p>Tidak ada tes lab hari ini</p>
                </div>
            `;
        }
    }
}

// Auto refresh data every 5 minutes
setInterval(() => {
    console.log('Auto-refreshing dashboard data...');
    location.reload();
}, 300000);
</script>

{% endblock %}