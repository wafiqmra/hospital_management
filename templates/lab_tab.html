{% extends "base.html" %}

{% block content %}
<!-- Lab Tests Tab -->
<div id="lab-tab" class="tab-content">
    <div class="filter-section">
        <form class="filter-form" method="GET">
            <div class="form-group">
                <label for="test_type">Test Type</label>
                <select name="test_type" id="test_type">
                    {% for type in lab_test_types %}
                        <option value="{{ type }}" {% if current_test_type == type %}selected{% endif %}>
                            {{ type }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group">
                <label for="result_status">Result Status</label>
                <select name="result_status" id="result_status">
                    {% for status in lab_result_statuses %}
                        <option value="{{ status }}" {% if current_result_status == status %}selected{% endif %}>
                            {{ status }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group">
                <label for="date_range">Date Range</label>
                <div style="display: flex; gap: 10px;">
                    <input type="date" name="start_date" id="start_date" value="{{ current_start_date }}">
                    <input type="date" name="end_date" id="end_date" value="{{ current_end_date }}">
                </div>
            </div>
            
            <button type="submit" class="btn">Apply Filters</button>
            <a href="/export_lab_tests?test_type={{ current_test_type }}&result_status={{ current_result_status }}&start_date={{ current_start_date }}&end_date={{ current_end_date }}" 
               class="btn btn-export">Export CSV</a>
            <a href="/lab" class="btn">Reset</a>
        </form>
    </div>
    
    <div class="metrics-grid">
        <div class="metric-card">
            <div class="metric-value">{{ total_lab_tests }}</div>
            <div class="metric-label">Total Tests</div>
        </div>
        <div class="metric-card">
            <div class="metric-value">{{ pending_tests }}</div>
            <div class="metric-label">Pending Results</div>
        </div>
        <div class="metric-card">
            <div class="metric-value">{{ completed_tests }}</div>
            <div class="metric-label">Completed Tests</div>
        </div>
        <div class="metric-card">
            <div class="metric-value">{{ lab_test_types_count }}</div>
            <div class="metric-label">Test Types</div>
        </div>
    </div>
    
    <div class="charts-grid">
        <div class="chart-container">
            <canvas id="testTypeChart"></canvas>
        </div>
        <div class="chart-container">
            <canvas id="resultStatusChart"></canvas>
        </div>
    </div>
    
    <div class="charts-grid">
        <div class="chart-container">
            <canvas id="dailyTestsChart"></canvas>
        </div>
        <div class="chart-container">
            <canvas id="labStaffChart"></canvas>
        </div>
    </div>
    
    <div class="table-container">
        <div class="table-header">
            <h3>Lab Test Records ({{ lab_table_count }} records)</h3>
        </div>
        <table>
            <thead>
                <tr>
                    <th>Test ID</th>
                    <th>Patient ID</th>
                    <th>Patient Name</th>
                    <th>Test Type</th>
                    <th>Scheduled Date</th>
                    <th>Result Date</th>
                    <th>Result Status</th>
                    <th>Lab Staff ID</th>
                </tr>
            </thead>
            <tbody id="lab-table-body">
                {% for test in lab_table_data %}
                <tr class="table-row" data-type="lab">
                    <td>{{ test.test_id }}</td>
                    <td>{{ test.patient_id }}</td>
                    <td>{{ test.patient_name }}</td>
                    <td>{{ test.test_type }}</td>
                    <td>{{ test.scheduled_date }}</td>
                    <td>{{ test.result_date if test.result_date else 'Not Available' }}</td>
                    <td>
                        <span class="status-badge 
                            {% if test.result_status == 'Completed' %}status-available
                            {% elif test.result_status == 'Pending' %}status-pending
                            {% else %}status-cancelled{% endif %}">
                            {{ test.result_status }}
                        </span>
                    </td>
                    <td>{{ test.lab_staff_id }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <div class="pagination" id="lab-pagination">
            <button class="pagination-btn" onclick="changePage('lab', -1)">Previous</button>
            <span class="pagination-info" id="lab-page-info">Page 1 of {{ (lab_table_count / 20)|round(0, 'ceil')|int }}</span>
            <button class="pagination-btn" onclick="changePage('lab', 1)">Next</button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Chart 1: Test Type Distribution
    const testTypeCtx = document.getElementById('testTypeChart');
    if (testTypeCtx) {
        const testTypeData = {{ test_type_count|tojson }};
        if (Object.keys(testTypeData).length > 0) {
            new Chart(testTypeCtx, {
                type: 'pie',
                data: {
                    labels: Object.keys(testTypeData),
                    datasets: [{
                        data: Object.values(testTypeData),
                        backgroundColor: [
                            '#4361ee', '#4cc9f0', '#7209b7', '#3a0ca3', 
                            '#f72585', '#4895ef', '#560bad', '#b5179e'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Distribution by Test Type'
                        }
                    }
                }
            });
        }
    }

    // Chart 2: Result Status
    const resultCtx = document.getElementById('resultStatusChart');
    if (resultCtx) {
        const resultData = {{ result_status_count|tojson }};
        if (Object.keys(resultData).length > 0) {
            new Chart(resultCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(resultData),
                    datasets: [{
                        label: 'Number of Tests',
                        data: Object.values(resultData),
                        backgroundColor: ['#4cc9f0', '#f72585', '#e63946']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Test Result Status'
                        }
                    }
                }
            });
        }
    }

    // Chart 3: Daily Tests Trend
    const dailyCtx = document.getElementById('dailyTestsChart');
    if (dailyCtx) {
        const dailyData = {{ daily_tests_data|tojson }};
        if (dailyData.length > 0) {
            new Chart(dailyCtx, {
                type: 'line',
                data: {
                    labels: dailyData.map(item => item.scheduled_date),
                    datasets: [{
                        label: 'Number of Tests',
                        data: dailyData.map(item => item.count),
                        borderColor: '#4361ee',
                        backgroundColor: 'rgba(67, 97, 238, 0.1)',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Daily Tests Trend'
                        }
                    }
                }
            });
        }
    }

    // Chart 4: Lab Staff
    const staffCtx = document.getElementById('labStaffChart');
    if (staffCtx) {
        const staffData = {{ lab_staff_count|tojson }};
        if (Object.keys(staffData).length > 0) {
            new Chart(staffCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(staffData),
                    datasets: [{
                        label: 'Number of Tests',
                        data: Object.values(staffData),
                        backgroundColor: '#7209b7'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Top 10 Lab Staff by Test Count'
                        }
                    }
                }
            });
        }
    }
});
</script>
{% endblock %}