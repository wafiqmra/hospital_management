{% extends "base.html" %}

{% block content %}
<!-- Doctor Schedule Tab -->
<div id="doctor-tab" class="tab-content active">
    <div class="filter-section">
        <form class="filter-form" method="GET">
            <div class="form-group">
                <label for="specialization">Specialization</label>
                <select name="specialization" id="specialization">
                    {% for spec in specializations %}
                        <option value="{{ spec }}" {% if current_specialization == spec %}selected{% endif %}>
                            {{ spec }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group">
                <label for="day">Day</label>
                <select name="day" id="day">
                    {% for day in days %}
                        <option value="{{ day }}" {% if current_day == day %}selected{% endif %}>
                            {{ day }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group">
                <label for="search_doctor">Search Doctor</label>
                <input type="text" name="search_doctor" id="search_doctor" 
                       value="{{ search_doctor }}" placeholder="Enter doctor name...">
            </div>
            
            <button type="submit" class="btn">Apply Filters</button>
            <a href="/export?specialization={{ current_specialization }}&day={{ current_day }}&search_doctor={{ search_doctor }}" 
               class="btn btn-export">Export CSV</a>
            <a href="/doctor" class="btn">Reset</a>
        </form>
    </div>
    
    <div class="metrics-grid">
        <div class="metric-card">
            <div class="metric-value">{{ total_doctors }}</div>
            <div class="metric-label">Total Doctors</div>
        </div>
        <div class="metric-card">
            <div class="metric-value">{{ total_schedules }}</div>
            <div class="metric-label">Total Schedules</div>
        </div>
        <div class="metric-card">
            <div class="metric-value">{{ total_specializations }}</div>
            <div class="metric-label">Specializations</div>
        </div>
        <div class="metric-card">
            <div class="metric-value">{{ total_doctor_rooms }}</div>
            <div class="metric-label">Rooms Used</div>
        </div>
    </div>
    
    <div class="charts-grid">
        <div class="chart-container">
            <canvas id="specializationChart"></canvas>
        </div>
        <div class="chart-container">
            <canvas id="dayChart"></canvas>
        </div>
        <div class="chart-container">
            <canvas id="heatmapChart"></canvas>
        </div>
        <div class="chart-container">
            <canvas id="roomUsageChart"></canvas>
        </div>
    </div>

    
    <div class="table-container">
        <div class="table-header">
            <h3>Doctor Schedules ({{ table_count }} records)</h3>
        </div>
        <table>
            <thead>
                <tr>
                    <th>Doctor Name</th>
                    <th>Specialization</th>
                    <th>Day</th>
                    <th>Start Time</th>
                    <th>End Time</th>
                    <th>Room ID</th>
                </tr>
            </thead>
            <tbody id="doctor-table-body">
                {% for row in table_data %}
                <tr class="table-row" data-type="doctor">
                    <td>{{ row.name }}</td>
                    <td>{{ row.specialization }}</td>
                    <td>{{ row.schedule_day }}</td>
                    <td>{{ row.start_time }}</td>
                    <td>{{ row.end_time }}</td>
                    <td>{{ row.room_id }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <div class="pagination" id="doctor-pagination">
            <button class="pagination-btn" onclick="changePage('doctor', -1)">Previous</button>
            <span class="pagination-info" id="doctor-page-info">Page 1 of {{ (table_count / 20)|round(0, 'ceil')|int }}</span>
            <button class="pagination-btn" onclick="changePage('doctor', 1)">Next</button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Chart 1: Distribution by Specialization
    const specCtx = document.getElementById('specializationChart');
    if (specCtx) {
        const specData = {{ spec_count|tojson }};
        if (Object.keys(specData).length > 0) {
            new Chart(specCtx, {
                type: 'pie',
                data: {
                    labels: Object.keys(specData),
                    datasets: [{
                        data: Object.values(specData),
                        backgroundColor: [
                            '#4361ee', '#4cc9f0', '#7209b7', '#3a0ca3', 
                            '#f72585', '#4895ef', '#560bad', '#b5179e'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Distribution by Specialization'
                        }
                    }
                }
            });
        }
    }

    // Chart 2: Schedules by Day
    const dayCtx = document.getElementById('dayChart');
    if (dayCtx) {
        const dayData = {{ day_count|tojson }};
        if (Object.keys(dayData).length > 0) {
            new Chart(dayCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(dayData),
                    datasets: [{
                        label: 'Number of Schedules',
                        data: Object.values(dayData),
                        backgroundColor: '#4361ee'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Schedules by Day'
                        }
                    }
                }
            });
        }
    }

    // Chart 3: Room Usage
    const roomCtx = document.getElementById('roomUsageChart');
    if (roomCtx) {
        const roomData = {{ room_usage_data|tojson }};
        if (roomData.length > 0) {
            new Chart(roomCtx, {
                type: 'bar',
                data: {
                    labels: roomData.map(item => item.room_id),
                    datasets: [{
                        label: 'Usage Count',
                        data: roomData.map(item => item.count),
                        backgroundColor: '#4cc9f0'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Top 10 Most Used Rooms'
                        }
                    }
                }
            });
        }
    }

    // Chart 4: Simple Heatmap
    const heatmapCtx = document.getElementById('heatmapChart');
    if (heatmapCtx) {
        const heatmapData = {{ heatmap_data|tojson }};
        if (heatmapData.length > 0) {
            // Group data untuk heatmap sederhana
            const days = [...new Set(heatmapData.map(item => item.schedule_day))];
            const specs = [...new Set(heatmapData.map(item => item.specialization))];
            
            const heatmapChartData = {
                labels: specs,
                datasets: days.map(day => {
                    return {
                        label: day,
                        data: specs.map(spec => {
                            const item = heatmapData.find(d => d.schedule_day === day && d.specialization === spec);
                            return item ? item.count : 0;
                        }),
                        backgroundColor: '#7209b7'
                    };
                })
            };

            new Chart(heatmapCtx, {
                type: 'bar',
                data: heatmapChartData,
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Schedule Density'
                        }
                    },
                    scales: {
                        x: {
                            stacked: true,
                        },
                        y: {
                            stacked: true
                        }
                    }
                }
            });
        }
    }
});
</script>
{% endblock %}